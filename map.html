<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vamdrup - Flyer-omdeling</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <!-- Leaflet.draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">

  <style>
    html,body,#map { height: 100%; margin:0; padding:0; }
    #topbar {
      position: absolute;
      left:10px; top:10px;
      z-index:1000;
      background: rgba(255,255,255,0.95);
      padding:10px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      font-family: system-ui,Segoe UI,Roboto,Arial;
    }
    #topbar h3 { margin:0 0 6px 0; font-size:16px; }
    #topbar button { margin:4px 2px 0 0; }
    #instructions { font-size:13px; color:#333; }
    a.small { font-size:13px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="topbar">
    <h3>Vamdrup — Flyer-omdeling</h3>
    <div id="instructions">
      Klik på <b>tegneværktøjet</b> for at markere hvor du har været.<br>
      Markeringer gemmes automatisk i din browser (localStorage).<br>
      Brug <b>Eksport</b> for at hente en fil, eller <b>Import</b> for at indlæse.
    </div>
    <div style="margin-top:8px">
      <button id="zoomToCity">Center Vamdrup</button>
      <button id="export">Eksport (.geojson)</button>
      <button id="importBtn">Import (.geojson)</button>
      <input type="file" id="importFile" accept=".geojson,.json" style="display:none" />
    </div>
    <div style="margin-top:8px">
      <a class="small" href="#" id="clearData">Slet alle markeringer</a>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet.draw JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>
    const initialLat = 55.4276;
    const initialLng = 9.2843;
    const initialZoom = 14;

    const map = L.map('map').setView([initialLat, initialLng], initialZoom);

    // Gråt kortlag (CartoDB Positron)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CARTO',
      maxZoom: 19
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      position: 'topright',
      draw: {
        polyline: { shapeOptions: { color: 'green', weight: 4 } },
        polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: 'green', fillOpacity: 0.4 } },
        rectangle: { shapeOptions: { color: 'green', fillOpacity: 0.4 } },
        circle: false,
        marker: { icon: new L.Icon.Default() }
      },
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    function styleLayer(layer) {
      if (layer.setStyle) layer.setStyle({ color: 'green', fillColor: 'green', fillOpacity: 0.4, weight: 3 });
    }

    function loadSaved() {
      const raw = localStorage.getItem('vamdrup_flyer_geojson');
      if (!raw) return;
      try {
        const geo = JSON.parse(raw);
        L.geoJSON(geo, {
          onEachFeature: function (f, l) {
            styleLayer(l);
            drawnItems.addLayer(l);
          }
        });
      } catch (e) {
        console.error('Kunne ikke indlæse gemt data', e);
      }
    }

    function saveToLocal() {
      const geo = drawnItems.toGeoJSON();
      localStorage.setItem('vamdrup_flyer_geojson', JSON.stringify(geo));
    }

    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      styleLayer(layer);
      drawnItems.addLayer(layer);
      saveToLocal();
    });

    map.on('draw:edited', saveToLocal);
    map.on('draw:deleted', saveToLocal);

    document.getElementById('export').onclick = function () {
      const geo = drawnItems.toGeoJSON();
      const blob = new Blob([JSON.stringify(geo, null, 2)], { type: 'application/geo+json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vamdrup_flyer_markeringer.geojson';
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
    document.getElementById('importFile').onchange = e => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const geo = JSON.parse(ev.target.result);
          drawnItems.clearLayers();
          L.geoJSON(geo, { onEachFeature: (f, l) => { styleLayer(l); drawnItems.addLayer(l); } });
          saveToLocal();
          alert('Importeret og gemt!');
        } catch (err) { alert('Fejl ved import: ikke gyldig GeoJSON'); }
      };
      reader.readAsText(f);
      e.target.value = '';
    };

    document.getElementById('clearData').onclick = e => {
      e.preventDefault();
      if (confirm('Slet alle markeringer?')) {
        drawnItems.clearLayers();
        localStorage.removeItem('vamdrup_flyer_geojson');
      }
    };

    document.getElementById('zoomToCity').onclick = () => map.setView([initialLat, initialLng], 15);

    loadSaved();
  </script>
</body>
</html>
